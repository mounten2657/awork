<!DOCTYPE html>
<html lang="utf-8">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>GAPIS LIST</title>
    <link rel="stylesheet" href="/assets/layui/css/layui.css">
    <style>
        .layui-form-checked[lay-skin=primary] i {background-color: #3296fa}
        .layui-btn.search {background-color: #3296fa}
        .layui-table-tool {background-color: #ffffff}
        .layui-table-tool-temp {margin-bottom: 5px}
        .layui-table-tool #keyword{width: 360px; margin-right: 10px;}
        .layui-container {width: 85%}
        .code {
            padding: 2px 4px;
            color: #d14;
            background-color: #fbfbfb;
            border: 1px solid #e1e1e8;
            white-space: nowrap;
            font-family:Monaco,Menlo,Consolas,"Courier New",monospace;
            font-size: 10px;
            border-radius: 3px;
            margin-left: 4px;
            margin-right: 4px;
        }
        .layui-form-label {padding: 9px 0;width: 80px;text-align: center}
        .layui-input-block {margin-left: 80px;}
        .gapis {height: 1.6em;margin-right: 10px}
        .gapis .layui-input-block {width: 150px}
        #yapi {background-color: #ffffff;margin-left: -2px}
        #yapi img {height: 100%;margin-top: -5px}
    </style>
</head>
<body>

<div class="layui-container">

    <blockquote class="layui-elem-quote" style="margin-top: 20px;">
        <div class="layui-text">
            <ul>
                <li>您当前预览的是：<code class="code">gapis</code> 平台的接口列表，可通过选择表格的接口平台下拉框进行切换；</li>
                <li>为解决 <code class="code">gapis</code> 平台接口难于查找的问题，而整理以下接口列表；可通过接口名、包名、方法名等关键词进行模糊搜索，快速定位接口。</li>
                <li>列表包含的字段有：
                    <code class="code">包名</code>、
                    <code class="code">方法名</code>、
                    <code class="code">接口名</code>、
                    <code class="code">接口描述</code>、
                    <code class="code">入参格式</code>、
                    <code class="code">出参格式</code>、
                    <code class="code">更新记录</code>、
                    <code class="code">接口指纹</code>
                    等，可以点击 <i class="layui-btn  layui-btn-primary  layui-btn-xs layui-icon layui-icon-cols"></i> 自定义要显示的列；</li>
                <li>点击 <code class="code">更新数据</code> 按钮，可将接口数据更新到最新版本，避免查漏数据；
                    点击 <code class="code">Yapi</code> 图标，支持将接口数据导入到
                    <a id="ylink" href="https://yapi.igancao.com/project/143/interface/api" target="_blank" title="前往 Yapi" class="code">Yapi</a> 中。</li>
            </ul>
        </div>
    </blockquote>

    <table id="table_api" lay-filter="table_api"></table>

</div>

</body>
</html>

<script type="text/html" id="toolbar">
    <div class="layui-inline layui-form-item gapis">
        <label class="layui-form-label">接口平台</label>
        <div class="layui-input-block">
            <select name="gapis" id="gapis" lay-filter="gapis" lay-verify="required">
                <option value="">请选择</option>
                <option value="base">gapis-base</option>
                <option value="biz">gapis-biz</option>
                <option value="medicine">gapis-medicine</option>
                <option value="scm">gapis-scm</option>
                <option value="crm">gapis-crm</option>
            </select>
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">关键词</label>
        <div class="layui-input-inline">
            <input class="layui-input" name="keyword" id="keyword"
                   placeholder="输入接口关键词进行搜索……" autocomplete="on">
        </div>
    </div>
    <button type="button" class="layui-btn layui-btn-sm search" lay-event="search">
        <i class="layui-icon"></i> 搜索
    </button>
    <button type="button" class="layui-btn layui-btn-danger layui-btn-sm sync" id="sync" lay-event="sync">
        <i class="layui-icon layui-icon-refresh"></i> 更新数据
    </button>
    <span type="button" class="layui-btn layui-btn-sm yapi" id="yapi" lay-event="yapi">
        <img src="/assets/layui/yapi.png">
    </span>
</script>
<script type="text/html" id="record-action">
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="info"><i class="layui-icon layui-icon-about" title="详情"></i></a>
    <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="debug"><i class="layui-icon layui-icon-release" title="调试"></i></a>
</script>

<script src="/assets/layui/layui.js"></script>
<script>

    layui.use(function () {
        var layer = layui.layer
            , form = layui.form
            , table = layui.table
            , $ = layui.jquery;

        var baseUri = '';
        var platform = [];
        if (0 !== window.location.pathname.indexOf('/list')) {
            baseUri = '/base';
        }

        // 表格渲染
        table.render({
            elem: '#table_api',
            title: 'EXCEL_' + new Date().getTime(),  // 导出文件名
            //data: data,  // 本地数据
            url: baseUri + '/list/api',
            method: 'post',
            where: {keyword: $('#keyword').val(), gapis: $('#gapis').val()},
            toolbar: '#toolbar',
            defaultToolbar: ['filter', 'exports', 'print'],
            // 将原始数据解析成 table 组件所规定的数据
            parseData: function (res) {
                return {
                    code: res.code,        // 解析接口状态
                    msg: res.msg,          // 解析接口提示
                    count: res.data.count, // 解析数据长度
                    data: res.data.list,   // 解析数据列表
                    extend: res.data,      // 解析额外参数
                }
            },
            response: {
                statusName: 'code',        // 规定数据状态的字段名称，默认：code
                statusCode: 0,             // 规定成功的状态码，默认：0
                msgName: 'msg',            // 规定状态信息的字段名称，默认：msg
                countName: 'count',        // 规定数据总数的字段名称，默认：count
                dataName: 'data',          // 规定数据列表的字段名称，默认：data
                extends: 'extend',         // 规定数据列表的默认数据
            },
            cols: [
                [
                    {field: 'id', title: '编号', width: 130, align: 'center', templet: function (val) {
                            //let index = val.LAY_TABLE_INDEX + 1;
                            let index = val.id;
                            if (index < 1000) {
                                index = (Array(3).join(0) + index).slice(-3);
                            }
                            return '🅘 No.' + index;
                        }},
                    {field: 'package', title: '包名', align: 'left'},
                    {field: 'class', title: '方法名', align: 'left'},
                    {field: 'class_explain', title: '接口名', align: 'left', templet: function (val){return val.class_explain}},
                    {field: 'attention_explain', title: '接口描述', align: 'left', templet: function (val){return val.attention_explain}},
                    {field: 'in_protocol_format', title: '入参格式', align: 'left', hide: true, templet: function (val){return JSON.stringify(val.in_protocol_format)}},
                    {field: 'out_protocol_format', title: '出参格式', align: 'left', hide: true, templet: function (val){return JSON.stringify(val.out_protocol_format)}},
                    {field: 'update_log', title: '更新记录', align: 'left', width: 180, templet: function (val){
                            let str = '';
                            let updateLog = JSON.parse(val.update_log);
                            $.each(updateLog, function (index, value) {
                                str += value.date + ' ' + value.name + ' ' + (!index ? '创建' : '编辑') + " \t<br>\r\n";
                            });
                            return str;
                        }},
                    {field: 'fingerprint', title: '接口指纹', align: 'left', hide: true, templet: function (val){return val.fingerprint}},
                    {field: '', title: '操作', width: 120, align: 'center', toolbar: '#record-action'}
                ]
            ],
            done: function (res) {
                platform = res.extend.platform;
                $('th').css({'background-color': '#f0f6fc'});
                $('.layui-laypage-em').css({'background-color': '#3296fa'});
                $('.layui-laypage a').css({'color': 'black','background-color': 'transparent'});
                let tdTip = '';
                $("td div").hover(function() {
                    //scrollWidth是包含内容的完全高度，offsetWidth是当前表格单元格的宽度。
                    if (this.offsetWidth < this.scrollWidth) {
                        var that = this;
                        var text = $(this).text();
                        tdTip = layer.tips(text, that, {tips: [2, '#3f3f3f'], time: 5000});
                    }
                }, function () {layer.close(tdTip);});
            },
            page: {theme: '#3296fa'},
            limit: 15,
            limits: [10,15,20,25,30,50,80,100,500,1000],
            loading: true,
            text: {none: '暂无数据！'}
        });

        // 顶部工具栏
        table.on('toolbar(table_api)', function (obj) {
            if (obj.event === 'search') {
                return tableReload();
            }
            if (obj.event === 'sync') {
                return tableSync();
            }
            if (obj.event === 'yapi') {
                return toYapi();
            }
        });
        // select change 事件监听
        form.on('select(gapis)', function (data) {
            return tableReload();
        });

        // 行内工具栏
        table.on('tool(table_api)', function (obj) {
            var data = obj.data;
            var url = platform[data.platform];
            if (obj.event === 'info') {
                window.open(url+'/reflection?ctl=doc&p='+data.package+'&c='+data.class);
            }
            if (obj.event === 'debug') {
                window.open(url+'/reflection?ctl=test&p='+data.package+'&c='+data.class);
            }
        });

        // 数据重载
        function tableReload() {
            var keyword = $('#keyword').val();
            var gapis = $('#gapis').val();
            table.reload('table_api', {
                page: {curr: 1}
                ,where: {keyword: keyword, platform: gapis}
            });
            $('#keyword').val(keyword);
            $('#gapis').val(gapis);
            initTip();
            return true;
        }

        // 数据同步
        function tableSync() {
            let index = layer.load(0, {shade: [0.2,'#3f3f3f'], time: 5000});
            var gapis = $('#gapis').val();
            $.ajax({
                url: baseUri + '/list/sync',
                data: {platform: gapis},
                method: 'post',
                success: function (res) {
                    layer.close(index);
                    layer.msg(res.msg)
                    return tableReload();
                },
                error: function (xhr,status,error) {
                    layer.close(index);
                    console.log(xhr,status,error);
                }
            });
            return true;
        }

        // 导入到 Yapi
        function toYapi() {
            let index = layer.load(0, {shade: [0.2,'#3f3f3f'], time: 60000});
            var keyword = $('#keyword').val();
            var gapis = $('#gapis').val();
            $.ajax({
                url: baseUri + '/list/yapi',
                data: {keyword: keyword, platform: gapis},
                method: 'post',
                success: function (res) {
                    layer.close(index);
                    layer.msg(res.msg)
                },
                error: function (xhr,status,error) {
                    layer.close(index);
                    console.log(xhr,status,error);
                }
            });
            return true;
        }

        // 提示初始化
        function initTip() {
            // 悬浮显示提示语
            var tipIndex = '';
            $('#yapi').hover(function () {
                tipIndex = layer.tips('一键导入到 Yapi 中', '#yapi', {area: ['auto', '2em'], time: 2000});
                $('.layui-layer-content').css('line-height', '1em');
            }, function () {layer.close(tipIndex);});
        }
        initTip();

    });
</script>

