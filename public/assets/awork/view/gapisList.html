<!DOCTYPE html>
<html lang="utf-8">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>GAPIS LIST</title>
    <link rel="stylesheet" href="/assets/layui/css/layui.css">
    <style>
        .layui-form-checked[lay-skin=primary] i {background-color: #3296fa}
        .layui-btn.search {background-color: #3296fa}
        .layui-table-tool {background-color: #ffffff}
        .layui-table-tool-temp {margin-bottom: 5px}
        .layui-table-tool #keyword{width: 360px; margin-right: 10px;}
        .layui-container {width: 85%}
        .code {
            padding: 2px 4px;
            color: #d14;
            background-color: #fbfbfb;
            border: 1px solid #e1e1e8;
            white-space: nowrap;
            font-family:Monaco,Menlo,Consolas,"Courier New",monospace;
            font-size: 10px;
            border-radius: 3px;
            margin-left: 4px;
            margin-right: 4px;
        }
        .layui-form-label {padding: 9px 0;width: 80px;text-align: center}
        .layui-input-block {margin-left: 80px;}
        .gapis {height: 1.6em;margin-right: 10px}
        .gapis .layui-input-block {width: 150px}
        #yapi {background-color: #ffffff;margin-left: -2px}
        #yapi img {height: 100%;margin-top: -5px}
    </style>
</head>
<body>

<div class="layui-container">

    <blockquote class="layui-elem-quote" style="margin-top: 20px;">
        <div class="layui-text">
            <ul>
                <li>æ‚¨å½“å‰é¢„è§ˆçš„æ˜¯ï¼š<code class="code">gapis</code> å¹³å°çš„æ¥å£åˆ—è¡¨ï¼Œå¯é€šè¿‡é€‰æ‹©è¡¨æ ¼çš„æ¥å£å¹³å°ä¸‹æ‹‰æ¡†è¿›è¡Œåˆ‡æ¢ï¼›</li>
                <li>ä¸ºè§£å†³ <code class="code">gapis</code> å¹³å°æ¥å£éš¾äºæŸ¥æ‰¾çš„é—®é¢˜ï¼Œè€Œæ•´ç†ä»¥ä¸‹æ¥å£åˆ—è¡¨ï¼›å¯é€šè¿‡æ¥å£åã€åŒ…åã€æ–¹æ³•åç­‰å…³é”®è¯è¿›è¡Œæ¨¡ç³Šæœç´¢ï¼Œå¿«é€Ÿå®šä½æ¥å£ã€‚</li>
                <li>åˆ—è¡¨åŒ…å«çš„å­—æ®µæœ‰ï¼š
                    <code class="code">åŒ…å</code>ã€
                    <code class="code">æ–¹æ³•å</code>ã€
                    <code class="code">æ¥å£å</code>ã€
                    <code class="code">æ¥å£æè¿°</code>ã€
                    <code class="code">å…¥å‚æ ¼å¼</code>ã€
                    <code class="code">å‡ºå‚æ ¼å¼</code>ã€
                    <code class="code">æ›´æ–°è®°å½•</code>ã€
                    <code class="code">æ¥å£æŒ‡çº¹</code>
                    ç­‰ï¼Œå¯ä»¥ç‚¹å‡» <i class="layui-btn  layui-btn-primary  layui-btn-xs layui-icon layui-icon-cols"></i> è‡ªå®šä¹‰è¦æ˜¾ç¤ºçš„åˆ—ï¼›</li>
                <li>ç‚¹å‡» <code class="code">æ›´æ–°æ•°æ®</code> æŒ‰é’®ï¼Œå¯å°†æ¥å£æ•°æ®æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œé¿å…æŸ¥æ¼æ•°æ®ï¼›
                    ç‚¹å‡» <code class="code">Yapi</code> å›¾æ ‡ï¼Œæ”¯æŒå°†æ¥å£æ•°æ®å¯¼å…¥åˆ°
                    <a id="ylink" href="https://yapi.igancao.com/project/143/interface/api" target="_blank" title="å‰å¾€ Yapi" class="code">Yapi</a> ä¸­ã€‚</li>
            </ul>
        </div>
    </blockquote>

    <table id="table_api" lay-filter="table_api"></table>

</div>

</body>
</html>

<script type="text/html" id="toolbar">
    <div class="layui-inline layui-form-item gapis">
        <label class="layui-form-label">æ¥å£å¹³å°</label>
        <div class="layui-input-block">
            <select name="gapis" id="gapis" lay-filter="gapis" lay-verify="required">
                <option value="">è¯·é€‰æ‹©</option>
                <option value="base">gapis-base</option>
                <option value="biz">gapis-biz</option>
                <option value="medicine">gapis-medicine</option>
                <option value="scm">gapis-scm</option>
                <option value="crm">gapis-crm</option>
            </select>
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">å…³é”®è¯</label>
        <div class="layui-input-inline">
            <input class="layui-input" name="keyword" id="keyword"
                   placeholder="è¾“å…¥æ¥å£å…³é”®è¯è¿›è¡Œæœç´¢â€¦â€¦" autocomplete="on">
        </div>
    </div>
    <button type="button" class="layui-btn layui-btn-sm search" lay-event="search">
        <i class="layui-icon">î˜•</i> æœç´¢
    </button>
    <button type="button" class="layui-btn layui-btn-danger layui-btn-sm sync" id="sync" lay-event="sync">
        <i class="layui-icon layui-icon-refresh"></i> æ›´æ–°æ•°æ®
    </button>
    <span type="button" class="layui-btn layui-btn-sm yapi" id="yapi" lay-event="yapi">
        <img src="/assets/layui/yapi.png">
    </span>
</script>
<script type="text/html" id="record-action">
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="info"><i class="layui-icon layui-icon-about" title="è¯¦æƒ…"></i></a>
    <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="debug"><i class="layui-icon layui-icon-release" title="è°ƒè¯•"></i></a>
</script>

<script src="/assets/layui/layui.js"></script>
<script>

    layui.use(function () {
        var layer = layui.layer
            , form = layui.form
            , table = layui.table
            , $ = layui.jquery;

        var baseUri = '';
        var platform = [];
        if (0 !== window.location.pathname.indexOf('/list')) {
            baseUri = '/base';
        }

        // è¡¨æ ¼æ¸²æŸ“
        table.render({
            elem: '#table_api',
            title: 'EXCEL_' + new Date().getTime(),  // å¯¼å‡ºæ–‡ä»¶å
            //data: data,  // æœ¬åœ°æ•°æ®
            url: baseUri + '/list/api',
            method: 'post',
            where: {keyword: $('#keyword').val(), gapis: $('#gapis').val()},
            toolbar: '#toolbar',
            defaultToolbar: ['filter', 'exports', 'print'],
            // å°†åŸå§‹æ•°æ®è§£ææˆ table ç»„ä»¶æ‰€è§„å®šçš„æ•°æ®
            parseData: function (res) {
                return {
                    code: res.code,        // è§£ææ¥å£çŠ¶æ€
                    msg: res.msg,          // è§£ææ¥å£æç¤º
                    count: res.data.count, // è§£ææ•°æ®é•¿åº¦
                    data: res.data.list,   // è§£ææ•°æ®åˆ—è¡¨
                    extend: res.data,      // è§£æé¢å¤–å‚æ•°
                }
            },
            response: {
                statusName: 'code',        // è§„å®šæ•°æ®çŠ¶æ€çš„å­—æ®µåç§°ï¼Œé»˜è®¤ï¼šcode
                statusCode: 0,             // è§„å®šæˆåŠŸçš„çŠ¶æ€ç ï¼Œé»˜è®¤ï¼š0
                msgName: 'msg',            // è§„å®šçŠ¶æ€ä¿¡æ¯çš„å­—æ®µåç§°ï¼Œé»˜è®¤ï¼šmsg
                countName: 'count',        // è§„å®šæ•°æ®æ€»æ•°çš„å­—æ®µåç§°ï¼Œé»˜è®¤ï¼šcount
                dataName: 'data',          // è§„å®šæ•°æ®åˆ—è¡¨çš„å­—æ®µåç§°ï¼Œé»˜è®¤ï¼šdata
                extends: 'extend',         // è§„å®šæ•°æ®åˆ—è¡¨çš„é»˜è®¤æ•°æ®
            },
            cols: [
                [
                    {field: 'id', title: 'ç¼–å·', width: 130, align: 'center', templet: function (val) {
                            //let index = val.LAY_TABLE_INDEX + 1;
                            let index = val.id;
                            if (index < 1000) {
                                index = (Array(3).join(0) + index).slice(-3);
                            }
                            return 'ğŸ…˜ No.' + index;
                        }},
                    {field: 'package', title: 'åŒ…å', align: 'left'},
                    {field: 'class', title: 'æ–¹æ³•å', align: 'left'},
                    {field: 'class_explain', title: 'æ¥å£å', align: 'left', templet: function (val){return val.class_explain}},
                    {field: 'attention_explain', title: 'æ¥å£æè¿°', align: 'left', templet: function (val){return val.attention_explain}},
                    {field: 'in_protocol_format', title: 'å…¥å‚æ ¼å¼', align: 'left', hide: true, templet: function (val){return JSON.stringify(val.in_protocol_format)}},
                    {field: 'out_protocol_format', title: 'å‡ºå‚æ ¼å¼', align: 'left', hide: true, templet: function (val){return JSON.stringify(val.out_protocol_format)}},
                    {field: 'update_log', title: 'æ›´æ–°è®°å½•', align: 'left', width: 180, templet: function (val){
                            let str = '';
                            let updateLog = JSON.parse(val.update_log);
                            $.each(updateLog, function (index, value) {
                                str += value.date + ' ' + value.name + ' ' + (!index ? 'åˆ›å»º' : 'ç¼–è¾‘') + " \t<br>\r\n";
                            });
                            return str;
                        }},
                    {field: 'fingerprint', title: 'æ¥å£æŒ‡çº¹', align: 'left', hide: true, templet: function (val){return val.fingerprint}},
                    {field: '', title: 'æ“ä½œ', width: 120, align: 'center', toolbar: '#record-action'}
                ]
            ],
            done: function (res) {
                platform = res.extend.platform;
                $('th').css({'background-color': '#f0f6fc'});
                $('.layui-laypage-em').css({'background-color': '#3296fa'});
                $('.layui-laypage a').css({'color': 'black','background-color': 'transparent'});
                let tdTip = '';
                $("td div").hover(function() {
                    //scrollWidthæ˜¯åŒ…å«å†…å®¹çš„å®Œå…¨é«˜åº¦ï¼ŒoffsetWidthæ˜¯å½“å‰è¡¨æ ¼å•å…ƒæ ¼çš„å®½åº¦ã€‚
                    if (this.offsetWidth < this.scrollWidth) {
                        var that = this;
                        var text = $(this).text();
                        tdTip = layer.tips(text, that, {tips: [2, '#3f3f3f'], time: 5000});
                    }
                }, function () {layer.close(tdTip);});
            },
            page: {theme: '#3296fa'},
            limit: 15,
            limits: [10,15,20,25,30,50,80,100,500,1000],
            loading: true,
            text: {none: 'æš‚æ— æ•°æ®ï¼'}
        });

        // é¡¶éƒ¨å·¥å…·æ 
        table.on('toolbar(table_api)', function (obj) {
            if (obj.event === 'search') {
                return tableReload();
            }
            if (obj.event === 'sync') {
                return tableSync();
            }
            if (obj.event === 'yapi') {
                return toYapi();
            }
        });
        // select change äº‹ä»¶ç›‘å¬
        form.on('select(gapis)', function (data) {
            return tableReload();
        });

        // è¡Œå†…å·¥å…·æ 
        table.on('tool(table_api)', function (obj) {
            var data = obj.data;
            var url = platform[data.platform];
            if (obj.event === 'info') {
                window.open(url+'/reflection?ctl=doc&p='+data.package+'&c='+data.class);
            }
            if (obj.event === 'debug') {
                window.open(url+'/reflection?ctl=test&p='+data.package+'&c='+data.class);
            }
        });

        // æ•°æ®é‡è½½
        function tableReload() {
            var keyword = $('#keyword').val();
            var gapis = $('#gapis').val();
            table.reload('table_api', {
                page: {curr: 1}
                ,where: {keyword: keyword, platform: gapis}
            });
            $('#keyword').val(keyword);
            $('#gapis').val(gapis);
            initTip();
            return true;
        }

        // æ•°æ®åŒæ­¥
        function tableSync() {
            let index = layer.load(0, {shade: [0.2,'#3f3f3f'], time: 5000});
            var gapis = $('#gapis').val();
            $.ajax({
                url: baseUri + '/list/sync',
                data: {platform: gapis},
                method: 'post',
                success: function (res) {
                    layer.close(index);
                    layer.msg(res.msg)
                    return tableReload();
                },
                error: function (xhr,status,error) {
                    layer.close(index);
                    console.log(xhr,status,error);
                }
            });
            return true;
        }

        // å¯¼å…¥åˆ° Yapi
        function toYapi() {
            let index = layer.load(0, {shade: [0.2,'#3f3f3f'], time: 60000});
            var keyword = $('#keyword').val();
            var gapis = $('#gapis').val();
            $.ajax({
                url: baseUri + '/list/yapi',
                data: {keyword: keyword, platform: gapis},
                method: 'post',
                success: function (res) {
                    layer.close(index);
                    layer.msg(res.msg)
                },
                error: function (xhr,status,error) {
                    layer.close(index);
                    console.log(xhr,status,error);
                }
            });
            return true;
        }

        // æç¤ºåˆå§‹åŒ–
        function initTip() {
            // æ‚¬æµ®æ˜¾ç¤ºæç¤ºè¯­
            var tipIndex = '';
            $('#yapi').hover(function () {
                tipIndex = layer.tips('ä¸€é”®å¯¼å…¥åˆ° Yapi ä¸­', '#yapi', {area: ['auto', '2em'], time: 2000});
                $('.layui-layer-content').css('line-height', '1em');
            }, function () {layer.close(tipIndex);});
        }
        initTip();

    });
</script>

